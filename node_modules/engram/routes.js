#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

try {

	var Result = require("engram/result").Result;
	var Ok = require("engram/result").Ok;
	var Err = require("engram/result").Err;

	var is = require("is");
	var express = require("express");

	var saveBookmark = require("engram/save-bookmark");
	var showBookmarks = require("engram/show-bookmarks");
	var URL = require("url");

	var exitHandler = require("engram/exit-handler");
	var mustache = require("mustache");
} catch (err) {

	log.fatal({
		message: err.message,
		stacK: err.stack }, "failed to load dependencies.");

	process.exit();
}

var api = express.Router();
var app = express.Router();

var parseURL = function (url) {

	return Result.of(function () {

		var parsed = URL.parse(url);

		if (!is.string(parsed.protocol)) {
			parsed.protocol = "http:";
			parsed.slashes = true;
		}

		return URL.format(parsed);
	});
};

app.get("/", function (req, res) {

	res.redirect("/bookmarks");
});

app.get("/bookmarks", function (req, res) {

	res.send(showBookmarks());
	res.status(200);

	res.contentType = "text/html; charset=utf8";

	res.end();
});

app.get("/favico.ico", function (req, res) {

	res.status(404);
	res.end();
});

app.get("/import", function (req, res) {});

app.get("/export", function (req, res) {});

app.get("/*", function (req, res) {

	var pathResult = Ok(req).then(function (req) {
		return req.url;
	}).then(function (url) {
		return url.slice(1);
	}).then(parseURL);

	pathResult.onOk(function (path) {

		log.info({ url: req.url }, "GET " + path);

		saveBookmark(path, new Date().getTime(), { req: req, res: res });
		res.status(204);
		res.contentType("text/html; charset=utf8");

		res.end();
	});

	pathResult.onErr(function (path) {

		log.error({ url: req.url }, "failed to save url");

		res.status(404);
		res.end();
	});
});

module.exports = {
	api: api,
	app: app
};
