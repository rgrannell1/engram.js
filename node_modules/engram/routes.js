#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var is = require("is");
var parse = require("engram/parse");
var express = require("express");
var bodyParser = require("body-parser");

var saveBookmark = require("engram/save-bookmark");
var showBookmarks = require("engram/show-bookmarks");

var fetchBookmark = require("engram/fetch-bookmark");
var fetchBookmarks = require("engram/fetch-bookmarks");

var fetchArchive = require("engram/fetch-archive");

var deleteBookmark = require("engram/delete-bookmark");

var importBookmarks = require("engram/import-bookmarks");

var URL = require("url");

var exitHandler = require("engram/exit-handler");
var mustache = require("mustache");
var validURL = require("valid-url");

var api = require("engram/routes-api");
var save = require("engram/routes-save");

var app = express.Router();

var routes = {
	get: {},
	post: {},
	"delete": {}
};

routes.get["/"] = function (req, res) {
	res.redirect("/bookmarks");
};

routes.get["/bookmarks"] = function (req, res) {

	log.info("GET /bookmarks");

	res.send(showBookmarks());
	res.status(200);

	res.contentType = "text/html; charset=utf8";
	res.end();
};

routes.get["/bookmarks/:id"] = function (req, res) {

	log.info("GET /bookmarks/" + req.params.id);

	var idResult = parse.id(req.params.id);

	idResult.onErr(function (_ref) {
		var message = _ref.message;
		var code = _ref.code;

		res.sendStatus(code);
	});

	idResult.onOk(fetchBookmark.bind({}, res));
};

routes.get["/archive/:id"] = function (req, res) {

	log.info("GET /archive/" + req.params.id);

	var idResult = parse.id(req.params.id);

	idResult.onErr(function (_ref) {
		var message = _ref.message;
		var code = _ref.code;

		res.sendStatus(code);
	});

	idResult.onOk(fetchArchive.bind({}, res));
};

routes.get["/favicon.ico"] = function (req, res) {
	res.sendStatus(404);
};

app.get("/", routes.get["/"]);
app.get("/bookmarks", routes.get["/bookmarks"]);
app.get("/bookmarks/:id", routes.get["/bookmarks/:id"]);

app.get("/archive/:id", routes.get["/archive/:id"]);

app.use("/public", express["static"]("" + process.cwd() + "/public"));
app.get("/favicon.ico", routes.get["/favicon.ico"]);

module.exports = {
	api: api,
	app: app,
	save: save
};