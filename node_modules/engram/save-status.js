#!/usr/bin/env node
"use strict";

var is = require("is");
var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var requestURL = require("engram/request-url");
var database = require("engram/database");

/*
	findUnresolvedURL(callback)

	select the URLS that don't have a status code.
*/

var findUnresolvedURL = function (callback) {

	var sql = "\n\tSELECT * FROM url\n\n\tWHERE url.status_code is NULL\n\n\tORDER BY RANDOM()\n\tLIMIT 1;\n\t";

	database.serialise(function (db) {

		db.all(sql, function (err, rows) {
			err ? callback(Err(err)) : callback(Ok(rows));
		});
	});
};

/*
	updateStatus(url, statusCode, callback)

	set the status code for a URL.

*/

var updateStatus = function (url, statusCode, callback) {

	updateStatus.precond(url, statusCode, callback);

	var sql = "UPDATE url SET status_code=$statusCode WHERE url = $url";

	database.serialise(function (db) {

		db.run(sql, {
			$url: url,
			$statusCode: statusCode
		}, function (err) {
			err ? callback(Err(err)) : callback(Ok(url));
		});
	});
};

updateStatus.precond = function (url, statusCode, callback) {

	is.always.string(url);
};

/*
	saveStatus(reporter, url)

	request a URL, and save it's to the database.
*/

var saveStatus = function (_ref, reporter) {
	var url = _ref.url;
	var res = _ref.res;
	var body = _ref.body;

	log.global.debug("saving status for " + url);

	saveStatus.precond({ url: url, res: res, body: body }, reporter);

	updateStatus(url, res.statusCode, function (result) {
		reporter(Ok(url));
	});
};

saveStatus.precond = function (_ref, reporter) {
	var url = _ref.url;
	var res = _ref.res;
	var body = _ref.body;

	is.always["function"](reporter);
};

module.exports = saveStatus;