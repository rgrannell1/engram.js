
"use strict"





var is        = require('is')
var log       = require('engram/logging/logger')
var constants = require('engram/commons/constants')
var path      = require('path')
var sqlite3   = require('sqlite3')





var loadDatabase = (dbPath, callback) => {

	if (!dbPath) dbPath = 'data/engram.db' // TODO horrid hack; remove.

	var fullPath = dbPath === constants.database.MEMORY
		? dbPath
		: path.join(process.cwd( ), dbPath)




	var dbconn
	var dbObject = {
		conn: ( ) => {

			if (!is.object(dbconn)) {

				dbconn = new sqlite3.Database(fullPath, err => {

					if (err) {
						log.global.fatal({err}, 'failed to load database.')
					}

				})

			}

			return dbconn

		},
		serialise: callback => {

			dbObject.conn( ).serialize(( ) => {
				callback(dbObject.conn( ))
			})

		},
		close: ( ) => {
			dbObject.conn( ).close( )
		}
	}

	callback(dbObject)

}




module.exports = loadDatabase
