
"use strict"




var is      = require('is')
var commons = require('engram/commons/commons')





var statements = [
	`
	CREATE TABLE IF NOT EXISTS bookmark (

		bookmarkId    integer    PRIMARY KEY    AUTOINCREMENT,
		url            text       NOT NULL       REFERENCES url(url),

		ctime          integer    NOT NULL       CHECK(ctime > 0 and ctime <= 4294967295)

	);`,

	`
	CREATE TABLE IF NOT EXISTS url (

		url              text       PRIMARY KEY,

		status_code      integer    CHECK(status_code > 0 and status_code < 600),
		is_soft_failer   integer,

		title            text

	);`,

	`
	CREATE TABLE IF NOT EXISTS archive (

		url             text       PRIMARY KEY    REFERENCES url(url),

		content         blob,
		content_type    text

	);`

]





var createTables = (database, callback) => {

	database.serialise(db => {

		var runSQL = (sql, done) => {

			db.run(sql, err => {
				done(err ? err : null)
			})

		}

		commons.async.collectMap(statements, runSQL, results => {
			callback(results.filter(is.error))
		})

	})

}





module.exports = createTables
