#!/usr/bin/env node
"use strict";

var log = require("engram/logger");
var is = require("is");

var database = require("engram/database");
var createTables = require("engram/create-tables");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var statements = ["\n\tCREATE TABLE IF NOT EXISTS bookmark (\n\n\t\tbookmark_id    integer    PRIMARY KEY    AUTOINCREMENT,\n\t\turl            text       NOT NULL       REFERENCES url(url),\n\n\t\tctime          integer    NOT NULL       CHECK(ctime > 0 and ctime <= 4294967295)\n\n\t);", "\n\tCREATE TABLE IF NOT EXISTS url (\n\n\t\turl              text       PRIMARY KEY,\n\n\t\tarchive_id       integer    REFERENCES content(archive_id),\n\n\t\tstatus_code      integer    CHECK(status_code > 0 and status_code < 600),\n\t\tis_soft_failer   integer,\n\n\t\ttitle            text\n\n\t);", "\n\tCREATE TABLE IF NOT EXISTS content (\n\n\t\tarchive_id      integer    PRIMARY KEY    AUTOINCREMENT,\n\n\t\tarchive         text    NOT NULL,\n\t\tcontent_type    text    NOT NULL,\n\n\t\tUNIQUE(archive, content_type)\n\n\t);"];

var createTables = function (callback) {

	database["do"](function (db, callback) {

		statements.forEach(function (sql) {

			log.info({ sql: sql }, "creating table.");
			db.run(sql, function (err) {

				if (err) {
					callback(Err(err));
				}
			});
		});

		// -- horrible! not running serially! need to await result of each callback.
		setTimeout(callback, 1000);
	}, callback);
};

module.exports = createTables;
