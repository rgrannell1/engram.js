#!/usr/bin/env node


"use strict";

var log = require('engram/es5/logging/logger');

var is = require('is');
var fs = require('fs');
var path = require('path');

var Result = require('engram/es5/result').Result;
var Ok = require('engram/es5/result').Ok;

var wipeData = function wipeData(args, callback) {

	wipeData.precond(args, callback);

	if (args.logs) {

		wipeData.logs(args, callback);
	} else if (args.db) {

		wipeData.database(args, callback);
	}
};

wipeData.precond = function (args) {

	is.always.object(args);
};

wipeData.logs = function (args, callback) {

	log.global.info('erasing all logs.');

	var logPath = 'log';

	var wipeResult = Ok(logPath).then(fs.readdirSync).then(function (filenames) {
		filenames.forEach(function (file) {
			return fs.unlinkSync(path.join(logPath, file));
		});
	});

	callback(wipeResult);
};

wipeData.database = function (args, callback) {

	log.global.info('erasing all database entries and tables.');

	var databasePath = 'data';
	var toKeep = ['data-bookmarks.json', 'ip-whitelist'];

	var wipeResult = Ok(databasePath).then(fs.readdirSync).then(function (files) {
		return files.filter(function (fname) {
			return toKeep.indexOf(fname) === -1;
		});
	}).then(function (files) {
		return files.forEach(function (file) {
			return fs.unlinkSync(path.join(databasePath, file));
		});
	});

	callback(wipeResult);
};

module.exports = wipeData;
