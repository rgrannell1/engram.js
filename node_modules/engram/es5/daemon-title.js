#!/usr/bin/env node


"use strict";

var Ok = require('engram/es5/result').Ok;
var Err = require('engram/es5/result').Err;

var database = require('engram/es5/database');
var extractTitle = require('engram/es5/extract-title');
var constants = require('engram/es5/constants');

var saveTitle = require('engram/es5/save-title');
var message = require('engram/es5/message');

var findUntitledURL = function findUntitledURL(callback) {

	var sql = '\n\tSELECT * FROM url\n\n\tWHERE url.title is NULL\n\n\tORDER BY RANDOM()\n\tLIMIT 1;\n\t';

	database.serialise(function (db) {

		db.all(sql, function (err, rows) {
			err ? callback(Err(err)) : callback(Ok(rows));
		});
	});
};

var job = function job(reporter) {
	findUntitledURL(function (urlResult) {

		urlResult.onErr(function (err) {
			reporter(Err(err));
		});

		urlResult.onOk(saveTitle.bind({}, reporter));
	});
};

var reporter = function reporter(saveResult) {

	constants.BUS.emit(message.TITLE_FINISHED, saveResult);
};

module.exports = {
	job: job,
	reporter: reporter,
	interval: 2 * 1000
};
