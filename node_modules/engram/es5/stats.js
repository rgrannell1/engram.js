#!/usr/bin/env node
"use strict";

var is = require("is");
var log = require("engram/es5/logger");

var Result = require("engram/es5/result").Result;
var Ok = require("engram/es5/result").Ok;
var Err = require("engram/es5/result").Err;

var constants = require("engram/es5/constants");
var message = require("engram/es5/message");

{
	(function () {
		var amount = 0;
		var startTime = undefined;
		var lastTime = undefined;

		constants.BUS.on(message.URL_RESOLVED, function (saveResult) {

			if (is.undefined(startTime)) {
				startTime = new Date().getTime();
			}

			lastTime = new Date().getTime();
			++amount;

			var rate = amount / ((lastTime - startTime) / 1000);

			log.stats.info("current rate: " + rate);
		});
	})();
}

constants.BUS.on(message.TITLE_FINISHED, function (saveResult) {

	saveResult.onErr(function (err) {
		log.stats.error({ message: err.message, stack: err.stack }, "title extraction failed.");
	});

	saveResult.onOk(function (url) {

		if (!is.undefined(url)) {
			log.stats.info("successfully extracted title for " + url);
		}
	});
});

constants.BUS.on(message.SOFTFAIL_FINISHED, function (saveResult) {

	saveResult.onErr(function (err) {
		log.stats.error({ message: err.message, stack: err.stack }, "soft-fail determination failed.");
	});

	saveResult.onOk(function (url) {

		if (!is.undefined(url)) {
			log.stats.info("successfully determinated soft-fail status for " + url);
		}
	});
});

constants.BUS.on(message.STATUS_FINISHED, function (saveResult) {

	saveResult.onErr(function (err) {
		log.stats.error({ message: err.message, stack: err.stack }, "status determination failed.");
	});

	saveResult.onOk(function (url) {

		if (!is.undefined(url)) {
			log.stats.info("successfully determinated fail status for " + url);
		}
	});
});

constants.BUS.on(message.ARCHIVE_FINISHED, function (archiveResult) {

	archiveResult.onErr(function (err) {
		log.stats.error({ message: err.message, stack: err.stack }, "status determination failed.");
	});

	archiveResult.onOk(function (url) {

		if (!is.undefined(url)) {
			log.stats.info("successfully saved archive for " + url);
		}
	});
});