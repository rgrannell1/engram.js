#!/usr/bin/env node
"use strict";

var is = require("is");
var log = require("engram/es5/logger");

var Result = require("engram/es5/result").Result;
var Ok = require("engram/es5/result").Ok;
var Err = require("engram/es5/result").Err;

var constants = require("engram/es5/constants");
var message = require("engram/es5/message");

{
	(function () {
		var amount = 0;
		var startTime = undefined;
		var lastTime = undefined;

		constants.BUS.on(message.URL_RESOLVED, function (saveResult) {

			if (is.undefined(startTime)) {
				startTime = new Date().getTime();
			}

			lastTime = new Date().getTime();
			++amount;

			var rate = amount / ((lastTime - startTime) / 1000);

			if (isFinite(rate)) {
				log.stats.info({ rate: rate }, "current rate: " + rate);
			}
		});
	})();
}

{

	constants.BUS.on(message.URL_RESOLVED, function (urlResult) {

		var totalTime = 0;
		var amount = 0;

		urlResult.onOk(function (_ref) {
			var res = _ref.res;
			var body = _ref.body;

			++amount;
			totalTime += res.requestTime || 0;
		});

		var averageTime = totalTime / amount;

		log.stats.info({ averageTime: averageTime }, "average request time: " + averageTime + " seconds.");
	});
}