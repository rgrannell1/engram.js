#!/usr/bin/env node


"use strict";

var is = require('is');
var log = require('engram/es5/logger');
var utils = require('engram/es5/utils');

var constants = require('engram/es5/constants');
var message = require('engram/es5/message');

{
	(function () {
		var amount = 0;
		var startTime = undefined;
		var lastTime = undefined;
		var hasNewInfo = false;

		constants.BUS.on(message.URL_RESOLVED, function () {

			if (is.undefined(startTime)) {
				startTime = new Date().getTime();
			}

			lastTime = new Date().getTime();
			amount++;

			hasNewInfo = true;
		});

		setInterval(function () {

			if (hasNewInfo) {

				var rate = (amount / ((lastTime - startTime) / constants.SECOND_IN_MS), 2).toFixed(2);

				if (isFinite(rate)) {
					log.stats.info({ perSecond: rate }, 'μ bookmarks per second.');
				}

				hasNewInfo = false;
			}
		}, 10 * constants.SECOND_IN_MS);
	})();
}

{
	(function () {

		var totalTime = 0;
		var amount = 0;
		var hasNewInfo = false;

		constants.BUS.on(message.URL_RESOLVED, function (urlResult) {

			urlResult.onOk(function (_ref) {
				var res = _ref.res;
				var body = _ref.body;

				amount++;
				totalTime += res.requestTime || 0;
			});

			hasNewInfo = true;
		});

		setInterval(function () {

			if (hasNewInfo) {

				var averageTime = (totalTime / amount).toFixed(2);

				log.stats.info({ averageTime: averageTime }, 'μ seconds per request.');
				hasNewInfo = false;
			}
		}, 10 * constants.SECOND_IN_MS);
	})();
}

{
	(function () {

		var failed = 0;
		var succeeded = 0;
		var hasNewInfo = false;

		constants.BUS.on(message.URL_RESOLVED, function (urlResult) {

			urlResult.onOk(function () {
				return ++succeeded;
			});
			urlResult.onErr(function () {
				return ++failed;
			});

			hasNewInfo = true;
		});

		setInterval(function () {

			if (hasNewInfo) {

				var averageRate = (succeeded / (failed + succeeded)).toFixed(2);

				log.stats.info({ failed: failed, succeeded: succeeded, averageRate: averageRate }, 'μ url success rate.');
				hasNewInfo = false;
			}
		}, 10 * constants.SECOND_IN_MS);
	})();
}

// -- security-related statistics

{

	var ips = [];

	constants.BUS.on(message.USER_RESOLVED, function (req) {

		var ipResult = utils.getIpAddress(req);

		ipResult.onOk(function (ip) {

			if (ips.indexOf(ip) === -1) {
				ips.push(ip);
			}

			log.stats.debug({ ips: ips }, 'served addresses.');
		});

		// -- probably never going to be called.
		ipResult.onErr(function (err) {
			log.global.error({ err: err }, 'could not extract ip address.');
		});
	});
}
