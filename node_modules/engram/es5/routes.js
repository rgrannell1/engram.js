#!/usr/bin/env node


"use strict";

var log = require('engram/es5/logger');

var parse = require('engram/es5/parse');
var express = require('express');

var showBookmarks = require('engram/es5/show-bookmarks');

var fetchBookmark = require('engram/es5/fetch-bookmark');

var fetchArchive = require('engram/es5/fetch-archive');

var api = require('engram/es5/routes-api');
var save = require('engram/es5/routes-save');

var app = express.Router();

var routes = {
	get: {},
	post: {},
	'delete': {}
};

routes.get['/'] = function (req, res) {
	res.redirect('/bookmarks');
};

routes.get['/bookmarks'] = function (req, res) {

	log.global.info({
		reqID: req.id
	}, 'GET /bookmarks');

	res.send(showBookmarks());
	res.status(200);

	res.contentType = 'text/html; charset=utf8';
	res.end();
};

routes.get['/bookmarks/:id'] = function (req, res) {

	log.global.info({
		reqID: req.id
	}, 'GET /bookmarks/' + req.params.id);

	var idResult = parse.id(req.params.id);

	idResult.onErr(function (_ref) {
		var message = _ref.message;
		var code = _ref.code;

		res.sendStatus(code);
	});

	idResult.onOk(fetchBookmark.bind({}, res));
};

routes.get['/archive/:id'] = function (req, res) {

	log.global.info({
		reqID: req.id
	}, 'GET /archive/' + req.params.id);

	var idResult = parse.id(req.params.id);

	idResult.onErr(function (_ref2) {
		var message = _ref2.message;
		var code = _ref2.code;

		res.sendStatus(code);
	});

	idResult.onOk(fetchArchive.bind({}, res));
};

routes.get['/favicon.ico'] = function (req, res) {
	res.sendStatus(404);
};

app.get('/', routes.get['/']);
app.get('/bookmarks', routes.get['/bookmarks']);
app.get('/bookmarks/:id', routes.get['/bookmarks/:id']);

app.get('/archive/:id', routes.get['/archive/:id']);

app.use('/public', express['static'](process.cwd() + '/public'));
app.get('/favicon.ico', routes.get['/favicon.ico']);

module.exports = {
	api: api,
	app: app,
	save: save
};
