#!/usr/bin/env node


"use strict";

var log = require('engram/es5/logger');
var is = require('is');

var database = require('engram/es5/database');
var createTables = require('engram/es5/create-tables');

var Result = require('engram/es5/result').Result;
var Ok = require('engram/es5/result').Ok;
var Err = require('engram/es5/result').Err;

var statements = ['\n\tCREATE TABLE IF NOT EXISTS bookmark (\n\n\t\tbookmarkId    integer    PRIMARY KEY    AUTOINCREMENT,\n\t\turl            text       NOT NULL       REFERENCES url(url),\n\n\t\tctime          integer    NOT NULL       CHECK(ctime > 0 and ctime <= 4294967295)\n\n\t);', '\n\tCREATE TABLE IF NOT EXISTS url (\n\n\t\turl              text       PRIMARY KEY,\n\n\t\tstatus_code      integer    CHECK(status_code > 0 and status_code < 600),\n\t\tis_soft_failer   integer,\n\n\t\ttitle            text\n\n\t);', '\n\tCREATE TABLE IF NOT EXISTS archive (\n\n\t\turl             text       PRIMARY KEY    REFERENCES url(url),\n\n\t\tcontent         blob,\n\t\tcontent_type    text\n\n\t);'];

var createTables = function createTables(callback) {

	database.serialise(function (db) {

		log.global.info('creating database tables.');

		statements.forEach(function (sql) {

			db.run(sql, function (err) {

				if (err) {
					callback(Err(err));
				}
			});
		});

		// -- horrible! not running serially! need to await result of each callback.
		setTimeout(callback, 1000);
	});
};

module.exports = createTables;
