#!/usr/bin/env node
"use strict";

var log = require("engram/es5/logger");

var is = require("is");

var Result = require("engram/es5/result").Result;
var Ok = require("engram/es5/result").Ok;
var Err = require("engram/es5/result").Err;

var routes = require("engram/es5/routes");
var database = require("engram/es5/database");

var sendNoArchive = function (res) {

	res.status(404);
	res.send("<h1>nothing to see :/</h1>");
};

var sendArchive = function (res, rowResult) {

	rowResult.onErr(function (err) {

		res.status(500);
		res.send(err.message);
	});

	rowResult.onOk(function (rows) {

		if (rows.length === 0) {

			sendNoArchive(res);
		} else {

			res.status(200);
			res.contentType(rows[0].contentType);

			res.send(rows[0].content);
		}
	});
};

var fetchArchive = function (res, id) {

	fetchArchive.precond(id);

	database.serialise(function (db) {

		var sql = "\n\t\tSELECT content, content_type AS contentType\n\t\tFROM archive\n\t\tWHERE archive.url = (\n\t\t\tSELECT url from bookmark\n\t\t\tWHERE bookmark.bookmarkId = $id)\n\n\t\tLIMIT 1;\n\t\t";

		db.all(sql, { $id: id }, function (err, rows) {
			sendArchive(res, err ? Err(err) : Ok(rows));
		});
	});
};

fetchArchive.precond = function (id) {
	is.always.number(id);
};

module.exports = fetchArchive;