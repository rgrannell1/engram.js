#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var is = require("is");

var extractTitle = require("engram/extract-title");
var createArchive = require("engram/create-archive");
var log = require("engram/logger");
var database = require("engram/database");

var requestURL = require("engram/request-url");

var findTitlelessURLs = function (callback) {

	var sql = "\n\tSELECT * FROM url\n\n\tWHERE url.title is NULL\n\n\tAND url.is_soft_failer == 0\n\tAND url.status_code NOT IN (403, 404, 410)\n\tAND url.status_code < 500;\n\t";
	database["do"](function (db, callback) {

		db.all(sql, function (err, rows) {
			err ? callback(Err(err)) : callback(Ok(rows));
		});
	}, callback);
};

var restartJob = function (now, jobRegister) {

	var neverStarted = jobRegister.checkin !== jobRegister.checkin;
	var notRunning = jobRegister.count === 0;
	var isStalled = now - jobRegister.checkin > jobRegister.restartTime;

	var needsRestart = neverStarted || isStalled || notRunning;

	if (!needsRestart) {
		return;
	}

	log.info("starting " + jobRegister.name);

	jobRegister.count += 1;
	jobRegister.checkin = now;

	jobRegister.job(jobRegister);
};