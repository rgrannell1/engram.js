#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var is = require("is");

var extractTitle = require("engram/extract-title");
var createArchive = require("engram/create-archive");
var log = require("engram/logger");
var database = require("engram/database");

var findTitlelessURLs = function (callback) {

	var sql = "\n\tSELECT url.url, url.url_id\n\tFROM url\n\tLEFT OUTER JOIN title on title.title_id = url.url_id\n\tWHERE title.title_id is NULL;\n\t";

	database["do"](function (db, callback) {

		db.all(sql, function (err, rows) {
			err ? callback(Err(err)) : callback(Ok(rows));
		});
	}, callback);
};

var findArchivelessURLs = function (callback) {

	var sql = "\n\tSELECT url.url, url.url_id\n\tFROM url\n\tLEFT OUTER JOIN archive on archive.archive_id = url.url_id\n\tWHERE archive.archive_id is NULL;\n\t";

	database["do"](function (db, callback) {

		db.all(sql, function (err, rows) {
			err ? callback(Err(err)) : callback(Ok(rows));
		});
	}, callback);
};

var titleWorker = findTitlelessURLs.bind({}, function (urlsResult) {

	urlsResult.onErr(function (err) {});

	urlsResult.onOk(function (urls) {
		urls.forEach(console.log);
	});
});

var moniterWorkers = function () {

	var workers = [{ interval: 10 * 1000, worker: titleWorker }];

	var pids = workers.map(function (_ref) {
		var interval = _ref.interval;
		var worker = _ref.worker;
		return setInterval(worker, interval);
	});
};

module.exports = moniterWorkers;

// -- note somewhere ?
//
