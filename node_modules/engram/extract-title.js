#!/usr/bin/env node
"use strict";

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var mimetype = require("engram/mimetype");

var phantom = require("phantom");
var $ = require("cheerio");
var log = require("engram/logger");

var headers = {
	headers: {
		"User-Agent": "Mozilla/5.0 (Windows NT 6.0) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.43 Safari/537.31"
	}
};

var extractResourceName = function (uri) {
	return "extracting resource name";
};

var getDomainName = function (uri) {};

var chooseBestTitle = function (url, titles) {};

var processPage = function (ph, status) {

	if (status !== "success") {
		extractTitle.html.js(url, res);
	}
};

var extractTitle = function (url, _ref, callback) {
	var body = _ref.body;
	var res = _ref.res;

	var contentType = res.headers["content-type"];
	var parsed = mimetype.parse(contentType);

	parsed.onErr(function (err) {
		log.warn({ contentType: contentType, err: err, url: url }, "content-type parsing failed.");
	});

	parsed.onOk(function (contentType) {

		if (mimetype.isHTML(contentType)) {

			extractTitle.html.phantom(url, res, callback);
		} else if (mimetype.isPDF(contentType)) {

			extractTitle.pdf(url, res, callback);
		} else {

			callback(extractResourceName(url));
		}
	});
};

extractTitle.html = function (url, res, callback) {
	extractTitle.html.phantom(url, res, callback);
};

extractTitle.html.js = function (url, res, callback) {
	callback("failed!");
};

extractTitle.html.phantom = function (url, res, callback) {

	var titleResult = Result.of(function () {

		phantom.create(function (ph) {
			ph.createPage(function (page) {

				page.open(url, headers, processPage.bind({}, ph));

				page.onResourceError = function (err) {
					extractTitle.html.js(url, res, callback);
				};
			});
		});
	});

	titleResult.onErr(function (err) {

		log.warn({ err: err, url: url }, "phantom-based title extraction failed.");
		extractTitle.html.js(url, res, callback);
	});
};

extractTitle.pdf = function (url, res, callback) {};

module.exports = extractTitle;
