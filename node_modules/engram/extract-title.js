#!/usr/bin/env node
"use strict";

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var mimetype = require("engram/mimetype");

var phantom = require("phantom");
var $ = require("cheerio");

var headers = {
	headers: {
		"User-Agent": "Mozilla/5.0 (Windows NT 6.0) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.43 Safari/537.31"
	}
};

var extractResourceName = function (uri) {};

var getDomainName = function (uri) {};

var chooseBestTitle = function (url, titles) {};

var processPage = function (ph, status) {

	if (status !== "success") {
		extractTitle.html.js(url, res);
	}
};

var extractTitle = function (url, _ref) {
	var body = _ref.body;
	var res = _ref.res;

	var contentType = res.headers["content-type"];
	var parsed = mimetype.parse(contentType);

	if (mimetype.isHTML(parsed)) {
		extractTitle.html.phantom(url, res);
	}

	if (mimetype.isPDF(parsed)) {
		extractTitle.pdf(url, res);
	}
};

extractTitle.html = function (url, res) {
	extractTitle.html.phantom(url, res);
};

extractTitle.html.js = function (url, res) {};

extractTitle.html.phantom = function (url, res) {

	phantom.create(function (ph) {
		ph.createPage(function (page) {
			page.open(url, headers, processPage.bind({}, ph));
		});
	});

	page.onResourceError = function (err) {
		extractTitle.html.js(url, res);
	};
};

extractTitle.pdf = function (url, res) {};

module.exports = extractTitle;
