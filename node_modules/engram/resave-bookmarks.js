#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

var is = require("is");
var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var saveBookmark = require("engram/save-bookmark");
var createArchive = require("engram/create-archive");
var log = require("engram/logger");
var database = require("engram/database");
var constants = require("engram/constants");

var request = require("request");

var publishURL = function (bookmark) {

	constants.BUS.fire(":url", {
		url: decodeURIComponent(bookmark.url),
		time: bookmark.ctime || Math.round(new Date().getTime() / 1000)
	});
};

var importBookmarks = function (body, req, res) {

	is.always.object(body);
	is.always.object(req);
	is.always.object(res);

	// -- cast the object to an array.
	var bookmarksResult = Result.of(function () {

		return Object.keys(body.data).filter(function (number) {
			return parseInt(number, 10) === parseInt(number, 10);
		}).map(function (key) {
			return body.data[key];
		});
	});

	bookmarksResult.then(function (data) {

		return data.sort(function (bookmark0, bookmark1) {
			return bookmark0.ctime - bookmark1.ctime;
		});
	}).then(function (urls) {
		urls.forEach(publishURL);
	});
};

module.exports = importBookmarks;