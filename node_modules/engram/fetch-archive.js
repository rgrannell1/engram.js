#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

var is = require("is");
var bunyan = require("bunyan");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var routes = require("engram/routes");
var database = require("engram/database");

var parseBookmarks = function (rows) {

	var bookmarkResults = rows.map(function (row) {
		return bookmark.bookmark(row);
	});

	var fails = bookmarkResults.filter(function (res) {
		return res.isErr;
	});
	var oks = bookmarkResults.filter(function (res) {
		return res.isOk;
	});

	if (fails.length > 0) {
		logger.warning({ fails: JSON.stringify(fails) }, "failed to reparse " + fails.length + " bookmarks.");
	}

	return Ok(oks).productOf();
};

var sendBookmarks = function (res, maxID, rowResult) {

	rowResult.onErr(function (err) {

		res.status(500);
		res.send(err.message);
	});

	rowResult.then(parseBookmarks).then(function (bookmarks) {

		var nextID = bookmarks.length > 0 ? bookmarks.map(function (book) {
			return bookmark.getID(book);
		}).reduce(function (num0, num1) {
			return Math.min(num0, num1);
		}) - 1 : maxID - 1;

		var body = JSON.stringify({ data: bookmarks, next_id: nextID });

		res.status(200);
		res.contentType("application/json");
		res.send(body);
	});
};

var fetchArchive = function (maxID, amount, res) {

	fetchArchive.precond(maxID, amount);

	database["do"](function (db, callback) {

		var sql = "\n\t\tSELECT content, content_type\n\t\tFROM archive\n\t\tWHERE archive.url = $url\n\t\tLIMIT $limit\n\t\t";

		db.run(sql, {

			$url: url }, function (err) {
			callback(err ? Err(err) : Ok(url));
		});
	}, callback);
};

fetchArchive.precond = function (maxID, amount) {

	is.always.number(maxID);
	is.always.number(amount);
};

module.exports = fetchArchive;