#!/usr/bin/env node

"use strict"




var is            = require('is')
var log           = require('engram/logger')

var Result        = require('engram/result').Result
var Ok            = require('engram/result').Ok
var Err           = require('engram/result').Err

var URL           = require('url')

var database      = require('engram/database')
var createArchive = require('engram/create-archive')

var requestURL    = require('engram/request-url')










var updateArchive = (url, {content, contentType}, callback) => {

	var sql = `UPDATE archive SET
		content      = $content,
		content_type = $contentType
		WHERE archive.url = $url`

	database.do((db, callback) => {

		db.run(sql, {

			$url:   url,
			$content:     content,
			$contentType: contentType

		}, err => {
			callback(err ? Err(err) : Ok(url))
		})

	}, callback)

}





var saveArchive = (reporter, urls) => {

	saveArchive.precond(reporter, urls)

	urls.length === 0
		? reporter(Ok(undefined))
		: createArchive(urls[0].url, archiveResult => {

			archiveResult.onErr(err => {
				reporter(Err(err))
			})

			archiveResult.onOk(archive => {

				updateArchive(urls[0].url, archive, reporter)

			})

		})

}

saveArchive.precond = (reporter, urls) => {

	is.always.function(reporter)
	is.always.array(urls)

}



module.exports = saveArchive
