#!/usr/bin/env node

"use strict"






var log             = require('engram/es5/logger')


var Result          = require('engram/es5/result').Result
var Ok              = require('engram/es5/result').Ok
var Err             = require('engram/es5/result').Err

var is              = require('is')
var parse           = require('engram/es5/parse')
var express         = require('express')
var bodyParser      = require('body-parser')

var saveBookmark    = require('engram/es5/save-bookmark')
var showBookmarks   = require('engram/es5/show-bookmarks')

var fetchBookmark   = require('engram/es5/fetch-bookmark')
var fetchBookmarks  = require('engram/es5/fetch-bookmarks')

var fetchArchive    = require('engram/es5/fetch-archive')

var deleteBookmark  = require('engram/es5/delete-bookmark')

var importBookmarks = require('engram/es5/import-bookmarks')

var URL             = require('url')

var exitHandler     = require('engram/es5/exit-handler')
var mustache        = require('mustache')
var validURL        = require('valid-url')

var api             = require('engram/es5/routes-api')
var save            = require('engram/es5/routes-save')




var app  = express.Router( )



var routes = {
	get:    { },
	post:   { },
	delete: { }
}





routes.get['/'] = (req, res) => {
	res.redirect('/bookmarks')
}





routes.get['/bookmarks'] = (req, res) => {

	log.global.info('GET /bookmarks')

	res.send(showBookmarks( ))
	res.status(200)

	res.contentType = 'text/html; charset=utf8'
	res.end( )

}

routes.get['/bookmarks/:id'] = (req, res) => {

	log.global.info(`GET /bookmarks/${req.params.id}`)

	var idResult = parse.id(req.params.id)





	idResult.onErr( ({message, code}) => {
		res.sendStatus(code)
	})

	idResult.onOk(
		fetchBookmark.bind({ }, res))

}





routes.get['/archive/:id'] = (req, res) => {

	log.global.info(`GET /archive/${req.params.id}`)

	var idResult = parse.id(req.params.id)





	idResult.onErr( ({message, code}) => {
		res.sendStatus(code)
	})

	idResult.onOk(
		fetchArchive.bind({ }, res))

}





routes.get['/favicon.ico'] = (req, res) => {
	res.sendStatus(404)
}




app.get('/',              routes.get['/'])
app.get('/bookmarks',     routes.get['/bookmarks'])
app.get('/bookmarks/:id', routes.get['/bookmarks/:id'])

app.get( '/archive/:id',  routes.get['/archive/:id'] )

app.use('/public',        express.static(`${process.cwd( )}/public`))
app.get('/favicon.ico',   routes.get['/favicon.ico'])







module.exports = {
	api,
	app,
	save
}
