#!/usr/bin/env node

"use strict"





var constants = require('engram/es5/constants')
var message   = require('engram/es5/message')
var utils     = require('engram/es5/utils')
var log       = require('engram/es5/logger')

var fs        = require('fs')




{

	let whitelist =
		fs.readFileSync('data/ip-whitelist')
		.toString( )
		.split('\n')
		.filter(val => val && val.length > 0)





	var logIpAddress = req => {

		utils.getIpAddress(req).onOk(ip => {

			var isUnknown = whitelist.indexOf(ip) === -1

			isUnknown
				? log.security.warning({
					ip: ip,
					url: req.originalURL
				}, 'non-whitelisted ip address connected!')
				: log.security.info({
					ip: ip,
					url: req.originalURL
				}, 'whitelisted ip address connected.')

		})

	}

}




var guardUser = function (req, res, next) {

	constants.BUS.emit(message.USER_RESOLVED, req)

	logIpAddress(req)

	next( )

}




module.exports = guardUser
