#!/usr/bin/env node

"use strict"





var log           = require('engram/logger')

var is            = require('is')
var Result        = require('engram/result').Result
var Ok            = require('engram/result').Ok
var Err           = require('engram/result').Err

var saveBookmark  = require('engram/save-bookmark')
var log           = require('engram/logger')
var database      = require('engram/database')

var constants     = require('engram/constants')
var message       = require('engram/message')

var request       = require('request')





var publishURL = bookmark => {

	constants.BUS.fire(message.URL_REQUESTED, {
		url:  decodeURIComponent(bookmark.url),
		time: bookmark.ctime || Math.round(new Date( ).getTime( ) / 1000)
	})

}





var importBookmarks = (body, res) => {

	importBookmarks.precond(body, res)

	// -- cast the object to an array.
	var importResult = Result.of(( ) => {

		return Object.keys(body.data)
			.filter(number => {
				return parseInt(number, 10) === parseInt(number, 10)
			})
			.map(key => body.data[key])

	})

	importResult.onErr(err => {

		log.info({message: err.message, stack: err.stack}, 'import failed.')

		res.status(500)
		res.end( )

	})

	importResult.onOk(data => {

		log.info({length: data.length}, 'import accepted.')

		res.status(202)
		res.end( )

		var staggeredTimeout = 0

		data
		.sort((bookmark0, bookmark1) => {
			return bookmark0.ctime - bookmark1.ctime
		})
		.forEach(bookmark => {

			staggeredTimeout += 500
			setTimeout(publishURL.bind({ }, bookmark), staggeredTimeout)

		})

	})

}

importBookmarks.precond = (body, res) => {
	is.always.object(body)
}




module.exports = importBookmarks
