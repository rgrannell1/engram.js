#!/usr/bin/env node

"use strict"





var log           = require('engram/logger')

var Result        = require('engram/result').Result
var Ok            = require('engram/result').Ok
var Err           = require('engram/result').Err

var extractTitle  = require('engram/extract-title')
var createArchive = require('engram/create-archive')
var log           = require('engram/logger')
var database      = require('engram/database')

var request       = require('request')






var requestUrl = (url, callback) => {

	var opts  = {
		url,
		headers: {
			'User-Agent': 'Mozilla/5.0 (Windows NT 6.0) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.43 Safari/537.31'
		}
	}

	request(opts, (err, res, body) => {

		if (err) {

			log.error({
				url,
				message: err.message,
				stack:   err.stack
			}, 'url lookup failed.')

			callback(Err(err.message))

		} else {

			log.info({url}, 'url lookup succeeded.')
			callback( Ok({res, body}) )

		}

	})

}





var insertBookmark = (url, time, title) => {

	database.do(db => {

		var statement = db.prepare('INSERT INTO bookmarks VALUES (NULL, ?, ?, ?);')

		statement.run(url, title, time)
		statement.finalize( )

	})

}

var insertArchive = () => {
	// -- TODO STUB.
}





var saveTitle = (url, time, content) => {
	extractTitle(url, content, insertBookmark.bind({ }, url, time))
}

var saveArchive = (url, content) => {

}





var saveBookmark = (url, time) => {

	requestUrl(url, contentResult => {

		contentResult.then(saveTitle.bind({ },   url, time))
		contentResult.then(saveArchive.bind({ }, url))

	})

}





module.exports = saveBookmark
