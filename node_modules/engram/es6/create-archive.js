#!/usr/bin/env node

"use strict"




var is           = require('is')
var log          = require('engram/logger')

var Result       = require('engram/result').Result
var Ok           = require('engram/result').Ok
var Err          = require('engram/result').Err

var ctype        = require('content-type')
var contentTypes = require('engram/content-types')

var requestURL   = require('engram/request-url')










var createArchive = (url, callback) => {

	requestURL(url, {encoding: null}, resResult => {

		resResult.onErr(err => {
			callback(Err(err))
		})

		resResult.onOk( ({res, body}) => {

			var contentType = res.headers['content-type'] || 'text/html'
			var parsed      = Result.of(( ) => ctype.parse(contentType))

			parsed.onErr(err => {

				log.error({
					contentType,
					message: err.message,
					stack:   err.stack,
					url
				}, 'content-type parsing failed.')

				callback(Err(err))

			})

			parsed.onOk(contentType => {

				contentTypes.isHTML(contentType)
					? createArchive.html(url, body, contentType, callback)
					: createArchive.fallback(url, body, contentType, callback)

			})

		})

	})

}





createArchive.html = (url, body, contentType, callback) => {

	createArchive.html.precond(url, body, contentType, callback)

	var content = new Buffer('<h1>hello!</h1>', 'binary')

	callback( Ok({
		content,
		contentType: ctype.format(contentType)
	}) )

}

createArchive.html.precond = (url, body, contentType, callback) => {

	is.always.string(url)
	is.always.object(body)
	is.always.object(contentType)

}





createArchive.fallback = (url, body, contentType, callback) => {

	createArchive.fallback.precond(url, body, contentType, callback)

	callback( Ok({
		content: body,
		contentType: ctype.format(contentType)
	}) )

}

createArchive.fallback.precond = (url, body, contentType, callback) => {

	is.always.string(url)
	is.always.object(body)
	is.always.object(contentType)

}




module.exports = createArchive
