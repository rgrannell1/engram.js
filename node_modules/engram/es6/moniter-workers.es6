#!/usr/bin/env node

"use strict"





var log           = require('engram/logger')

var Result        = require('engram/result').Result
var Ok            = require('engram/result').Ok
var Err           = require('engram/result').Err

var is            = require('is')

var extractTitle  = require('engram/extract-title')
var createArchive = require('engram/create-archive')
var log           = require('engram/logger')
var database      = require('engram/database')

var requestURL    = require('engram/request-url')





var findTitlelessURLs = callback => {

	var sql = `
	SELECT * FROM url

	WHERE url.title is NULL

	AND url.is_soft_failer == 0
	AND url.status_code NOT IN (403, 404, 410)
	AND url.status_code < 500;
	`
	database.do((db, callback) => {

		db.all(sql, (err, rows) => {
			err ? callback(Err(err)) : callback(Ok(rows))
		})

	}, callback)

}































var restartJob = (now, jobRegister) => {

	var neverStarted = jobRegister.checkin !== jobRegister.checkin
	var notRunning   = jobRegister.count === 0
	var isStalled    = now - jobRegister.checkin > jobRegister.restartTime

	var needsRestart = neverStarted || isStalled || notRunning

	if (!needsRestart) {
		return
	}

	log.info(`starting ${jobRegister.name}`)

	jobRegister.count   += 1
	jobRegister.checkin = now

	jobRegister.job(jobRegister)

}
