#!/usr/bin/env node

"use strict"





var is        = require('is')
var log       = require('engram/es5/logger')
var utils     = require('engram/es5/utils')

var constants = require('engram/es5/constants')
var message   = require('engram/es5/message')





{
	let amount = 0
	let startTime
	let lastTime
	let hasNewInfo = false

	constants.BUS.on(message.URL_RESOLVED, ( ) => {

		if (is.undefined(startTime)) {
			startTime = (new Date( )).getTime( )
		}

		lastTime = (new Date( )).getTime( )
		amount++

		hasNewInfo = true

	})

	setInterval(( ) => {

		if (hasNewInfo) {

			var rate = (amount / ((lastTime - startTime) / constants.SECOND_IN_MS), 2).toFixed(2)

			if (isFinite(rate)) {
				log.stats.info({perSecond: rate}, `μ bookmarks per second.`)
			}

			hasNewInfo = false

		}

	}, 10 * constants.SECOND_IN_MS)

}




{

	let totalTime = 0
	let amount    = 0
	let hasNewInfo = false

	constants.BUS.on(message.URL_RESOLVED, urlResult => {

		urlResult.onOk( ({res, body}) => {

			amount++
			totalTime += (res.requestTime || 0)

		})

		hasNewInfo = true

	})

	setInterval(( ) => {

		if (hasNewInfo) {

			var averageTime = (totalTime / amount).toFixed(2)

			log.stats.info({averageTime}, `μ seconds per request.`)
			hasNewInfo = false

		}

	}, 10 * constants.SECOND_IN_MS)

}





{

	let failed     = 0
	let succeeded  = 0
	let hasNewInfo = false

	constants.BUS.on(message.URL_RESOLVED, urlResult => {

		urlResult.onOk (( ) => ++succeeded)
		urlResult.onErr(( ) => ++failed)

		hasNewInfo = true

	})

	setInterval(( ) => {

		if (hasNewInfo) {

			var averageRate = (succeeded / (failed + succeeded)).toFixed(2)

			log.stats.info({failed, succeeded, averageRate}, `μ url success rate.`)
			hasNewInfo = false

		}

	}, 10 * constants.SECOND_IN_MS)

}





// -- security-related statistics

{

	var ips = [ ]

	constants.BUS.on(message.USER_RESOLVED, req => {

		var ipResult = utils.getIpAddress(req)

		ipResult.onOk(ip => {

			if (ips.indexOf(ip) === -1) {
				ips.push(ip)
			}

			log.stats.debug({ips}, 'served addresses.')

		})

		// -- probably never going to be called.
		ipResult.onErr(err => {
			log.global.error({err}, 'could not extract ip address.')
		})

	})

}
