#!/usr/bin/env node

"use strict"





var is        = require('is')
var log       = require('engram/es5/logger')

var constants = require('engram/es5/constants')
var message   = require('engram/es5/message')





{
	let amount = 0
	let startTime
	let lastTime

	constants.BUS.on(message.URL_RESOLVED, ( ) => {

		if (is.undefined(startTime)) {
			startTime = (new Date( )).getTime( )
		}

		lastTime = (new Date( )).getTime( )
		amount++

		var rate = amount / ((lastTime - startTime) / 1000)

		if (isFinite(rate)) {
			log.stats.info({rate}, `current rate: ${rate}`)
		}


	})

}




{

	let totalTime = 0
	let amount    = 0

	constants.BUS.on(message.URL_RESOLVED, urlResult => {

		urlResult.onOk( ({res, body}) => {

			amount++
			totalTime += (res.requestTime || 0)

		})

		var averageTime = Math.round(totalTime / amount, 1)

		log.stats.info({averageTime}, `average request time: ${averageTime} seconds.`)

	})

}





{

	let failed     = 0
	let succeeded  = 0
	let amount     = 0

	constants.BUS.on(message.URL_RESOLVED, urlResult => {

		amount++

		urlResult.onOk (( ) => ++succeeded)
		urlResult.onErr(( ) => ++failed)

		var averageRate = Math.round(succeeded / amount, 1)

		log.stats.info({failed, succeeded, amount}, `average success rate: ${averageRate}`)


	})

}