#!/usr/bin/env node

"use strict"





var Ok           = require('engram/es6/result').Ok
var Err          = require('engram/es6/result').Err

var database     = require('engram/es6/database')
var extractTitle = require('engram/es6/extract-title')
var constants    = require('engram/es6/constants')

var saveTitle    = require('engram/es6/save-title')
var message      = require('engram/es6/message')







var findUntitledURL = callback => {

	var sql = `
	SELECT * FROM url

	WHERE url.title is NULL

	ORDER BY RANDOM()
	LIMIT 1;
	`

	database.serialise(db => {

		db.all(sql, (err, rows) => {
			err ? callback(Err(err)) : callback(Ok(rows))
		})

	})

}




var job = reporter => {
	findUntitledURL(urlResult => {

		urlResult.onErr(err => {
			reporter(Err(err))
		})

		urlResult.onOk(saveTitle.bind({ }, reporter))

	})
}




var reporter = saveResult => {

	constants.BUS.emit(message.TITLE_FINISHED, saveResult)

}





module.exports = {
	job,
	reporter,
	interval: 2 * constants.SECOND_IN_MS
}
