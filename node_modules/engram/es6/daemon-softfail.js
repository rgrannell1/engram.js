#!/usr/bin/env node

"use strict"





var log                = require('engram/logger')

var Result             = require('engram/result').Result
var Ok                 = require('engram/result').Ok
var Err                = require('engram/result').Err

var requestURL         = require('engram/request-url')
var URL                = require('url')

var database           = require('engram/database')
var constants          = require('engram/constants')

var saveSoftFailStatus = require('engram/save-softfail')







/*
	findUncheckedURL(callback)

	select a URL that doesn't have a soft-fail status.
*/

var findUncheckedURL = callback => {

	var sql = `
	SELECT * FROM url

	WHERE url.is_soft_failer is NULL

	ORDER BY RANDOM()
	LIMIT 1;
	`

	database.serialise(db => {

		db.all(sql, (err, rows) => {
			err ? callback(Err(err)) : callback(Ok(rows))
		})

	})

}





var reporter = urlResult => {

	constants.BUS.fire(':softfail', urlResult)

}




var job = reporter => {

	findUncheckedURL(urlResult => {
		urlResult.then(saveSoftFailStatus.bind({ }, reporter))
	})

}





module.exports = {
	job,
	reporter,
	interval: 10 * 1000
}
