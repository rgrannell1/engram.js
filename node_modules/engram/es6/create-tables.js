#!/usr/bin/env node

"use strict"





var log          = require('engram/es6/logging/logger')
var is           = require('is')

var constants    = require('engram/es6/constants')
var database     = require('engram/es6/database')
var createTables = require('engram/es6/create-tables')

var Result       = require('engram/es6/result').Result
var Ok           = require('engram/es6/result').Ok
var Err          = require('engram/es6/result').Err





var statements = [
	`
	CREATE TABLE IF NOT EXISTS bookmark (

		bookmarkId    integer    PRIMARY KEY    AUTOINCREMENT,
		url            text       NOT NULL       REFERENCES url(url),

		ctime          integer    NOT NULL       CHECK(ctime > 0 and ctime <= 4294967295)

	);`,

	`
	CREATE TABLE IF NOT EXISTS url (

		url              text       PRIMARY KEY,

		status_code      integer    CHECK(status_code > 0 and status_code < 600),
		is_soft_failer   integer,

		title            text

	);`,

	`
	CREATE TABLE IF NOT EXISTS archive (

		url             text       PRIMARY KEY    REFERENCES url(url),

		content         blob,
		content_type    text

	);`

]





var createTables = callback => {

	database.serialise(db => {

		log.global.debug('creating database tables.')

		statements.forEach(sql => {

			db.run(sql, err => {

				if (err) {
					callback(Err(err))
				}

			})

		})

		// -- TODO horrible! not running serially! need to await result of each callback.
		setTimeout(callback, constants.SECOND_IN_MS, Ok( ))

	})

}





module.exports = createTables
