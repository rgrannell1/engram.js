#!/usr/bin/env node

"use strict"





var Ok            = require('engram/es6/result').Ok
var Err           = require('engram/es6/result').Err

var is            = require('is')

var createArchive = require('engram/es6/create-archive')
var database      = require('engram/es6/database')











var insertURL = (urlResult, callback) => {

	urlResult.onErr(err => {
		callback(Err(err))
	})

	urlResult.onOk(url => {

		database.serialise(db => {

			db.run('INSERT OR IGNORE INTO url VALUES ($url, NULL, NULL, NULL);', {

				$url: url,

			}, err => {
				insertArchive(err ? Err(err) : Ok(url), callback)
			})

		})


	})

}





var insertArchive = (urlResult, callback) => {

	urlResult.onErr(err => {
		callback(Err(err))
	})

	urlResult.onOk(url => {

		database.serialise(db => {

			db.run('INSERT OR IGNORE INTO archive VALUES ($url, NULL, NULL);', {

				$url: url

			}, err => {
				callback(err ? Err(err) : Ok( ))
			})

		})

	})

}





var saveBookmark = (url, time, callback) => {

	database.serialise(db => {

		db.run('INSERT INTO bookmark VALUES (NULL, $url, $ctime);', {

			$url:   url,
			$ctime: time

		}, function (err) {
			insertURL(err ? Err(err) : Ok(url), callback)
		})


	})

}




module.exports = saveBookmark
