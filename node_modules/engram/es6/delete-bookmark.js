#!/usr/bin/env node

"use strict"





var is        = require('is')
var log       = require('engram/logger')

var Result    = require('engram/result').Result
var Ok        = require('engram/result').Ok
var Err       = require('engram/result').Err

var database  = require('engram/database')
var bookmark  = require('engram/bookmark')
var constants = require('engram/constants')





var deleteBookmark = (res, id) => {

	database.do((db, callback) => {

		var sql = 'DELETE FROM bookmark WHERE bookmark_id = ?'
		db.run(sql, id)

		callback( )

	}, removeUnreferencedURL.bind({ }, res))

}





var removeUnreferencedURL = res =>{

	database.do((db, callback) => {

		var sql = `
		DELETE FROM url
		WHERE url NOT IN (SELECT url from bookmark);
		`

		db.run(sql)

		callback( )

	}, removeUnreferencedArchive.bind({ }, res))

}




var removeUnreferencedArchive = res => {

	database.do((db, callback) => {

		var sql = `
		DELETE FROM archive
		WHERE url NOT IN (SELECT url from bookmark);
		`

		db.run(sql)

		callback( )

	}, ( ) => {

		res.status(204)
		res.end( )

	})

}





module.exports = deleteBookmark
