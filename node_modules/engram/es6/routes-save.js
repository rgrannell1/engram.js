#!/usr/bin/env node

"use strict"





var log                = require('engram/es6/logging/logger')

var Result             = require('engram/es6/result').Result
var Ok                 = require('engram/es6/result').Ok
var Err                = require('engram/es6/result').Err

var is                 = require('is')
var utils              = require('engram/es6/utils')
var express            = require('express')

var saveBookmark       = require('engram/es6/save-bookmark')

var URL                = require('url')
var validURL           = require('valid-url')

var saveArchive        = require('engram/es6/save-archive')
var saveSoftFailStatus = require('engram/es6/save-softfail')
var saveStatus         = require('engram/es6/save-status')
var saveTitle          = require('engram/es6/save-title')

var constants          = require('engram/es6/constants')
var message            = require('engram/es6/message')

var requestURL         = require('engram/es6/request-url')





require('engram/es6/stats')
require('engram/es6/job-result')









var save = express.Router({
	strict:      true,
	mergeParams: true
})





var parseURL = url => {

	return Result.of(( ) => {

		var parsed = URL.parse(url)

		if (!is.string(parsed.protocol)) {
			url = 'http://' + url
		}

		return validURL.is_web_uri(url)
			? Ok(url)
			: Err(url)

	})

}






save.use((req, res) => {

	var pathResult = Ok(req)
		.then(req => req.url)
		.then(url => url.slice(1))
		.then(parseURL)

	pathResult.onErr(path => {

		log.global.error({
			url:   req.url,
			reqID: req.id,
			path:  path
		}, `failed to save url`)

		res.status(404)
		res.end( )

	})

	pathResult.onOk(url => {

		log.global.info({req}, `GET /${url}`)

		if (utils.isIgnoredURL(url)) {

			log.global.info({
				url:   req.url,
				reqID: req.id
			}, 'ignoring url.')

			res.sendStatus(404)

		} else {

			var time = Math.round(new Date( ) / constants.SECOND_IN_MS)

			constants.BUS.emit(message.URL_REQUESTED, {
				url, time, res
			})

		}

	})

})




// -- TODO factor out this gigantic function.
constants.BUS.on(message.URL_REQUESTED, ({url, time, res}) => {

	saveBookmark(url, time, result => {

		result.onErr(err => {

			log.global.error({
				err
			}, `failed to save ${url}`)

			if (res) {

				res.status(500)
				res.send(`whoops! ${url} failed.`)
				res.end( )

			}

		})

		result.onOk(( ) => {

			if (res) {
				res.status(204)
				res.end( )
			}

			requestURL(url, {encoding: null}, reqResult => {

				reqResult.onErr( ({uri, err}) => {
					log.global.error({err}, `failed to save ${uri}`)
				})

				reqResult.onOk( ({res, body}) => {

					saveStatus({url, res, body}, res => {
						constants.BUS.emit(message.STATUS_FINISHED, res)
					})

					saveTitle({url, res, body}, res => {
						constants.BUS.emit(message.TITLE_FINISHED, res)
					})

					saveSoftFailStatus({url, res, body}, res => {
						constants.BUS.emit(message.SOFTFAIL_FINISHED, res)
					})

					saveArchive({url, res, body}, res => {
						constants.BUS.emit(message.ARCHIVE_FINISHED, res)
					})


				})

			})

		})

	})

})





module.exports = save

