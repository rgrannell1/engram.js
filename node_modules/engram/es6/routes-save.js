#!/usr/bin/env node

"use strict"





var log                = require('engram/logger')

var Result             = require('engram/result').Result
var Ok                 = require('engram/result').Ok
var Err                = require('engram/result').Err

var is                 = require('is')
var express            = require('express')

var saveBookmark       = require('engram/save-bookmark')

var URL                = require('url')
var validURL           = require('valid-url')

var saveArchive        = require('engram/save-archive')
var saveSoftFailStatus = require('engram/save-softfail')
var saveStatus         = require('engram/save-status')
var saveTitle          = require('engram/save-title')
var constants          = require('engram/constants')









var save = express.Router({
	strict:      true,
	mergeParams: true
})





var parseURL = url => {

	return Result.of(( ) => {

		var parsed = URL.parse(url)

		if (!is.string(parsed.protocol)) {
			url = 'http://' + url
		}


		return validURL.is_web_uri(url)
			? Ok(url)
			: Err(url)

	})

}






save.use((req, res) => {

	var pathResult = Ok(req)
		.then(req => req.url)
		.then(url => url.slice(1))
		.then(parseURL)

	pathResult.onErr(path => {

		log.error({url: req.url}, `failed to save url`)

		res.status(404)
		res.end( )

	})

	pathResult.onOk(url => {

		log.info({url: req.url}, `GET ${url}`)

		var time = Math.round(new Date( ).getTime( ) / 1000)

		constants.BUS.fire(':url', {
			url,
			time,
			res
		})
	})

})





constants.BUS.on(':url', ({url, time, res}) => {

	saveBookmark(url, time, result => {

		result.onErr(err => {

			log.error({
				message: err.message,
				stack:   err.stack
			}, `failed to save ${url}`)

			if (res) {

				res.status(500)
				res.send(`whoops! ${url} failed.`)
				res.end( )

			}

		})

		result.onOk(_ => {

			if (res) {
				res.status(204)
				res.end( )
			}

			saveStatus(
				constants.BUS.fire.bind(constants.BUS, ':status'),   [{url}] )

			saveSoftFailStatus(
				constants.BUS.fire.bind(constants.BUS, ':softfail'), [{url}] )

			saveTitle(
				constants.BUS.fire.bind(constants.BUS, ':title'),    [{url}] )

			saveArchive(
				constants.BUS.fire.bind(constants.BUS, ':archive'),  [{url}] )

		})

	})

})










module.exports = save

