#!/usr/bin/env node

"use strict"





var log              = require('engram/logger')

var Result           = require('engram/result').Result
var Ok               = require('engram/result').Ok
var Err              = require('engram/result').Err

var parseContentType = require('content-type').parse
var contentTypes     = require('engram/content-types')

var $                = require('cheerio')
var path             = require('path')
var URL              = require('url')





var headers = {
	headers: {
		'User-Agent': 'Mozilla/5.0 (Windows NT 6.0) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.43 Safari/537.31'
	}
}




var trimTitle = (uri, title) => {

	var delimiter = /[ \t]+[|\-—»][ \t]+[^|\-—»]+$/g
	return title.replace(delimiter, '')

}




var extractResourceName = uri => {
	return path.basename(URL.parse(uri).pathname)
}

var chooseBestTitle = (url, titles) => {

	var fallback = {
		tag:         undefined,
		text:        URL.parse(url).hostname,
		'font-size': -1
	}

	return trimTitle(url,
		titles
		.concat([fallback])
		.filter(title => {
			return title.text.length > 0
		})
		[0]
		.text
	)

}






var extractTitle = ({url, res, body}, callback) => {

	var contentType = res.headers['content-type'] || 'text/html'
	var parsed      = Result.of(( ) => parseContentType(contentType))

	parsed.onErr(err => {

		log.global.warn({
			contentType,
			message: err.message,
			stack:   err.stack,
			url
		}, 'content-type parsing failed.')

	})

	parsed.onOk(contentType => {

		if (contentTypes.isHTML(contentType)) {

			extractTitle.html({url, res, body}, callback)

		} else if (contentTypes.isPDF(contentType)) {

			extractTitle.pdf({url, res, body}, callback)

		} else {

			callback( Ok(extractResourceName(url)) )

		}

	})

}





extractTitle.html = ({url, res, body}, callback) => {

	var $html = $(res.body.toString('utf8'))

	var extractTagInfo = tagName => {

		var $tag = $html.find(tagName)

		if ($tag.length === 0) {
			return [ ]
		} else if ($tag.length === 1) {

			return [{
				tag:         tagName,
				text:        $tag.text( ).trim( ),
				'font-size': -1
			}]

		} else {

			return $tag.map( ({ith, elem}) => {
				return {
					tag:         tagName,
					text:        $(elem).text( ).trim( ),
					'font-size': -1
				}
			})
			.get( )

		}

	}

	var titles = [ ]

	;['title', 'h1'].forEach(tagName => {
		titles = titles.concat(extractTagInfo(tagName))
	})

	callback( Ok(chooseBestTitle(url, titles)) )

}





extractTitle.pdf = ({url, res, body}, callback) => {

}





module.exports = extractTitle
