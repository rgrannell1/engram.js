#!/usr/bin/env node

"use strict"





var log = require('engram/logger')

var is           = require('is')
var https        = require('https')
var express      = require('express')
var bunyan       = require('bunyan')

var routes       = require('engram/routes')
var database     = require('engram/database')
var createTables = require('engram/create-tables')

var exitHandler  = require('engram/exit-handler')





var create = ({port}) => {

	var app = express( )

	app
	.listen(port, ( ) => {
		log.info(`engram listening on port ${port}`)
	})
	.on('error', err => {

		var handled = {
			EADDRINUSE: `port ${port} currently in use`
		}

		err.code in handled
			? log.error(handled[err.code])
			: log.error(err.toString( ))

	})

	createTables(( ) => {

		app
		.use('/api', routes.api)
		.use('/',    routes.app)
		.use('/',    routes.save)

		process.on('uncaughtException', exitHandler.bind({ }, true))
		process.on('SIGINT',            exitHandler.bind({ }, true))
		process.on('exit',              exitHandler.bind({ }, false))

	})

}





module.exports = create
