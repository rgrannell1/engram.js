#!/usr/bin/env node

"use strict"





var Ok                 = require('engram/es5/result').Ok
var Err                = require('engram/es5/result').Err

var database           = require('engram/es5/database')
var constants          = require('engram/es5/constants')

var saveSoftFailStatus = require('engram/es5/save-softfail')
var message            = require('engram/es5/message')






/*
	findUncheckedURL(callback)

	select a URL that doesn't have a soft-fail status.
*/

var findUncheckedURL = callback => {

	var sql = `
	SELECT * FROM url

	WHERE url.is_soft_failer is NULL

	ORDER BY RANDOM()
	LIMIT 1;
	`

	database.serialise(db => {

		db.all(sql, (err, rows) => {
			err ? callback(Err(err)) : callback(Ok(rows))
		})

	})

}





var reporter = urlResult => {

	constants.BUS.emit(message.SOFTFAIL_FINISHED, urlResult)

}




var job = reporter => {

	findUncheckedURL(urlResult => {

		urlResult.then(saveSoftFailStatus.bind({ }, reporter))

	})

}





module.exports = {
	job,
	reporter,
	interval: 10 * constants.SECOND_IN_MS
}
