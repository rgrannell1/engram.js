#!/usr/bin/env node

"use strict"




var is           = require('is')
var Ok           = require('engram/es5/result').Ok
var Err          = require('engram/es5/result').Err

var database     = require('engram/es5/database')
var constants    = require('engram/es5/constants')

var saveStatus   = require('engram/es5/save-status')
var message      = require('engram/es5/message')




/*
	findUnresolvedURL(callback)

	select the URLS that don't have a status code.
*/

var findUnresolvedURL = callback => {

	var sql = `
	SELECT * FROM url

	WHERE url.status_code is NULL

	ORDER BY RANDOM()
	LIMIT 1;
	`

	database.serialise(db => {

		db.all(sql, (err, rows) => {
			err ? callback(Err(err)) : callback(Ok(rows))
		})

	})


}





/*
	save a single unresolved URL to the database before reporting.
*/

var job = reporter => {

	var onURL = urlResult => {

		urlResult.onErr(errData => {
			reporter(Err(errData))
		})

		urlResult.onOk(saveStatus.bind({ }, reporter))

	}

	onURL.precond = urlResult => {
		is.always.object(urlResult)
	}

	findUnresolvedURL(onURL)

}





/*
	report whether a url was found or not.
*/

var reporter = urlResult => {

	reporter.precond(urlResult)

	constants.BUS.fire(message.STATUS_FINISHED, urlResult)

}

reporter.precond = urlResult => {
	is.always.object(urlResult)
}





module.exports = {
	reporter,
	job,
	interval: 30 * 1000
}
