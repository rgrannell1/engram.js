#!/usr/bin/env node

"use strict"




var is           = require('is')
var log          = require('engram/logger')

var Result       = require('engram/result').Result
var Ok           = require('engram/result').Ok
var Err          = require('engram/result').Err

var requestURL   = require('engram/request-url')
var database     = require('engram/database')






/*
	findUnresolvedURL(callback)

	select the URLS that don't have a status code.
*/

var findUnresolvedURL = callback => {

	var sql = `
	SELECT * FROM url

	WHERE url.status_code is NULL

	ORDER BY RANDOM()
	LIMIT 1;
	`

	database.do((db, callback) => {

		db.all(sql, (err, rows) => {
			err ? callback(Err(err)) : callback(Ok(rows))
		})

	}, callback)


}






/*
	updateStatus(url, statusCode, callback)

	set the status code for a URL.

*/

var updateStatus = (url, statusCode, callback) => {

	updateStatus.precond(url, statusCode, callback)




	var sql = `UPDATE url SET status_code=$statusCode WHERE url = $url`

	database.do((db, callback) => {

		db.run(sql, {
			$url:        url,
			$statusCode: statusCode
		})

	}, callback)

}

updateStatus.precond = (url, statusCode, callback) => {

	is.always.string(url)

}





/*
	saveStatus(reporter, url)

	request a URL, and save it's to the database.
*/

var saveStatus = (reporter, urls) => {

	saveStatus.precond(reporter, urls)

	var onURL = reqResult => {

		onURL.precond(reqResult)

		reqResult.onErr( errData => {
			reporter(Err(errData))
		})

		reqResult.onOk( ({res, body}) => {

			updateStatus(urls[0].url, res.statusCode, result => {
				reporter(Ok(urls[0].url))
			})

		})

	}

	onURL.precond = urlsResult => {
		is.always.object(urlsResult)
	}



	urls.length === 0
		? reporter( Ok([ ]) )
		: requestURL(urls[0].url, { }, onURL)

}

saveStatus.precond = (reporter, urls) => {
	is.always.array(urls)
}




/*
	save a single unresolved URL to the database before reporting.
*/

var job = reporter => {

	var onURL = urlResult => {

		urlResult.onErr(errData => {
			reporter(Err(errData))
		})

		urlResult.onOk(saveStatus.bind({ }, reporter))

	}

	onURL.precond = urlResult => {
		is.always.object(urlResult)
	}

	findUnresolvedURL(onURL)

}





/*
	report whether a url was found or not.
*/

var reporter = urlResult => {

	reporter.precond(urlResult)

	console.log( urlResult )

	/*
	urlResult.onErr( ({url, err}) => {
		state.stats.fails.push(url)
	})

	urlResult.onOk(url => {

		log.info(url)

		if (url.length === 0){
			state.stats.noURL += 1
		} else {
			state.stats.found.push(url)
		}

	})
	*/

}

reporter.precond = urlResult => {
	is.always.object(urlResult)
}





module.exports = {
	reporter,
	job,
	interval: 5 * 60 * 1000
}
