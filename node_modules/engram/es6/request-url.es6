#!/usr/bin/env node

"use strict"





var log           = require('engram/logger')

var Result        = require('engram/result').Result
var Ok            = require('engram/result').Ok
var Err           = require('engram/result').Err

var is            = require('is')
var request       = require('request')

var extractTitle  = require('engram/extract-title')
var createArchive = require('engram/create-archive')
var log           = require('engram/logger')
var sizeof        = require('object-sizeof')






var cache = {
	order: [ ],
	value: { }
}





var cachedRequest = (uri, options, callback) =>{

	if (cache.value.hasOwnProperty(uri)) {

		log.info({ }, `returning cached copy ${uri}`)

		callback( Ok({
			res: cache.value[uri].res,
			body: cache.value[uri].body
		}) )

	} else {

		log.info({ }, `cache miss for ${uri}`)

		request(uri, options, (err, res, body) => {

			if (err) {

				callback( Err(err) )

			} else {

				cache.value[uri] = {res, body}
				cache.order.push(cache.value[uri])

				callback( Ok({res, body}) )

			}

		})

	}

}





var requestURL = (uri, opts, callback) => {

	log.info({ }, `looking up ${uri}`)

	try {
		cachedRequest(uri, opts, callback)
	} catch (err) {
		callback(Err(err))
	}

}






module.exports = requestURL
