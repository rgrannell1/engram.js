#!/usr/bin/env node
"use strict";

var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var requestURL = require("engram/request-url");
var URL = require("url");

var database = require("engram/database");
var constants = require("engram/constants");

var saveSoftFailStatus = require("engram/save-softfail");

/*
	findUncheckedURL(callback)

	select a URL that doesn't have a soft-fail status.
*/

var findUncheckedURL = function (callback) {

	var sql = "\n\tSELECT * FROM url\n\n\tWHERE url.is_soft_failer is NULL\n\n\tORDER BY RANDOM()\n\tLIMIT 1;\n\t";

	database.serialise(function (db) {

		db.all(sql, function (err, rows) {
			err ? callback(Err(err)) : callback(Ok(rows));
		});
	});
};

var reporter = function (urlResult) {

	constants.BUS.fire(message.SOFTFAIL_FINISHED, urlResult);
};

var job = function (reporter) {

	findUncheckedURL(function (urlResult) {

		urlResult.then(saveSoftFailStatus.bind({}, reporter));
	});
};

module.exports = {
	job: job,
	reporter: reporter,
	interval: 10 * 1000
};