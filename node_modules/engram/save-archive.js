#!/usr/bin/env node
"use strict";

var is = require("is");
var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var URL = require("url");

var database = require("engram/database");
var createArchive = require("engram/create-archive");

var requestURL = require("engram/request-url");

var updateArchive = function (url, _ref, callback) {
	var content = _ref.content;
	var contentType = _ref.contentType;

	var sql = "UPDATE archive SET\n\t\tcontent      = $content,\n\t\tcontent_type = $contentType\n\t\tWHERE archive.url = $url";

	database["do"](function (db, callback) {

		db.run(sql, {

			$url: url,
			$content: content,
			$contentType: contentType

		}, function (err) {
			callback(err ? Err(err) : Ok(url));
		});
	}, callback);
};

var saveArchive = function (reporter, urls) {

	saveArchive.precond(reporter, urls);

	urls.length === 0 ? reporter(Ok(undefined)) : createArchive(urls[0].url, function (archiveResult) {

		archiveResult.onErr(function (err) {
			reporter(Err(err));
		});

		archiveResult.onOk(function (archive) {

			updateArchive(urls[0].url, archive, reporter);
		});
	});
};

saveArchive.precond = function (reporter, urls) {

	is.always["function"](reporter);
	is.always.array(urls);
};

module.exports = saveArchive;