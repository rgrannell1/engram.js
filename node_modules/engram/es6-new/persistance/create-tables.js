
"use strict"





var commons = require('engram/es6-new/commons/commons')
var Result  = require('engram/es6-new/commons/result').Result
var Ok      = require('engram/es6-new/commons/result').Ok
var Err     = require('engram/es6-new/commons/result').Err







var statements = [
	`
	CREATE TABLE IF NOT EXISTS bookmark (

		bookmarkId    integer    PRIMARY KEY    AUTOINCREMENT,
		url            text       NOT NULL       REFERENCES url(url),

		ctime          integer    NOT NULL       CHECK(ctime > 0 and ctime <= 4294967295)

	);`,

	`
	CREATE TABLE IF NOT EXISTS url (

		url              text       PRIMARY KEY,

		status_code      integer    CHECK(status_code > 0 and status_code < 600),
		is_soft_failer   integer,

		title            text

	);`,

	`
	CREATE TABLE IF NOT EXISTS archive (

		url             text       PRIMARY KEY    REFERENCES url(url),

		content         blob,
		content_type    text

	);`

]





var createTables = (database, callback) => {


	// TODO add async creation of each table,
	//      then call callback with database.

	database.serialise(db => {

		var runSQL = (sql, done) => {

			db.run(sql, err => {
				done(err ? Err(err) : Ok( ))
			})

		}

		commons.async.collectMap(statements, runSQL, results => {
			callback(Result.productOf(results))
		})

	})

}





module.exports = createTables
