#!/usr/bin/env node
"use strict";

var is = require("is");
var log = require("engram/logger");

var Result = require("engram/result").Result;
var Ok = require("engram/result").Ok;
var Err = require("engram/result").Err;

var database = require("engram/database");
var bookmark = require("engram/bookmark");
var constants = require("engram/constants");

var deleteBookmark = function (res, id) {

	database.serialise(function (db) {

		var sql = "DELETE FROM bookmark WHERE bookmarkId = ?";
		db.run(sql, id);

		removeUnreferencedURL(res, id);
	});
};

var removeUnreferencedURL = function (res) {

	database.serialise(function (db) {

		var sql = "\n\t\tDELETE FROM url\n\t\tWHERE url NOT IN (SELECT url from bookmark);\n\t\t";

		db.run(sql);

		removeUnreferencedArchive(res);
	});
};

var removeUnreferencedArchive = function (res) {

	database.serialise(function (db) {

		var sql = "\n\t\tDELETE FROM archive\n\t\tWHERE url NOT IN (SELECT url from bookmark);\n\t\t";

		db.run(sql);

		res.status(204);
		res.end();
	});
};

module.exports = deleteBookmark;